<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>What to eat?</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.0.0/dist/css/bootstrap.min.css">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Roboto+Condensed:ital,wght@0,400;0,700;1,400;1,700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="/styles.css">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
</head>

<body>

    <div class="banner">
        <div class="background-image"></div> 
        <div class = "banner-text"> 
        <h1 class="banner-h1">Welcome to the site!</h1>
        <h5 class = "banner-h5" >Don't know what to eat today? You come to the right place!</h5>

    </div>  

 <div id="page-body" class="container-xxl shadow-lg">


    <div class = "sidebar">

        <div class = "sidebar_menu">

            <h2> Filter: </h2>
        
            <div class="ingredient_list">
                <br>
                <h5 class = "h5-style"> Ingredients:</h5>

                <div class="checkbox">
                    <label><input type="checkbox" value="Rice" onchange="change();"/> Rice</label>
                </div>
                
                <div class="checkbox">
                    <label><input type="checkbox" value="Coconut Milk" onchange="change();"/> Coconut Milk</label>
                </div>

                <div class="checkbox">
                    <label><input type="checkbox" value="Chicken" onchange="change();"/> Chicken</label>
                </div>
        
            </div>

            <hr class="line">

            <div class="cuisine_filter">
                
                <h5 class = "h5-style"> Cuisines:</h5>

                <div class="cuisine-list">

                    <div class="checkbox2">
                        <label><input type="checkbox" value="Malaysian" onchange="change();"/> Malaysian</label>
                    </div>

                    
                    <div class="checkbox2">
                        <label><input type="checkbox" value="Western" onchange="change();"/> Western</label>
                    </div>
                  
                    <div class="checkbox2">
                        <label><input type="checkbox" value="Indian" onchange="change();"/> Indian</label>
                    </div>
        
                   
                </div>

            </div>


            <hr class="line">
            <br>

            <button class="btn btn-showall" onclick="showAllRecipe()">Show All Recipes!</button>


        </div>

       
    </div>

    <div class="body_container">

        <div class="text_container">
                
            <h2>Results</h2>

        </div>
            
            <div class="card-container" id="recipeResult">
            <!-- Recipe titles will be dynamically generated here -->   

            

            </div>

        </div>       
    </div>

     <!-- The Modal -->
  <div class="modal" id="myModal">
    <div class="modal-dialog">
      <div class="modal-content">
      
        <!-- Modal Header -->
        <div class="modal-header">
          <h4 class="modal-title"></h4>
          <button type="button" class="close" data-dismiss="modal">&times;</button>
        </div>
        
        <!-- Modal body -->
        <div class="modal-body">
          
    </div>
   </div> 
       
   
</div>
    
</body>

<script>

//The main functions
function change() {
  // Declare variables
  const input = document.querySelectorAll('.ingredient_list input[type=checkbox]');
  const cuisineInput = document.querySelectorAll('.cuisine-list input[type=checkbox]');

  // Selected ingredients & cuisines are now stored in the respective array
  const selectedIngredients = Array.from(input)
    .filter(checkbox => checkbox.checked)
    .map(checkbox => checkbox.value);

  const selectedCuisine = Array.from(cuisineInput)
    .filter(checkbox => checkbox.checked)
    .map(checkbox => checkbox.value);

  // Filter for ingredients Only

  if (selectedIngredients.length > 0) {
    var Ingredientdata = {
      ingredients: selectedIngredients.join(',')
    };
  }
// var data = {
//       cuisine: selectedCuisine.join(','),
//       ingredients: selectedIngredients.join(',')
//     };

  // Make an AJAX request to the server-side route for filtering

  // Filter for ingredients AND Cuisine (main)
  // Checks if BOTH array lengths are more than 0

  if (selectedCuisine.length > 0 && selectedIngredients.length > 0) {
    
    $.ajax({
      url: '/recipes/filter/' + selectedIngredients.join(',') + '/' + selectedCuisine.join(','),
      type: 'GET',
      success: function (response) {
        console.log('Filtered recipes:', response);
        //Update to show cards
        displayFilteredRecipes(response);
      },
      error: function (xhr, status, error) {
        console.log('Error filtering recipes by cuisine:', error);
      }
    });
  } 
  
  // Filter for ingredients ONLY 
  else if (selectedIngredients.length > 0) {
    
    $.ajax({
    url: '/recipes/ingredients/' + selectedIngredients.join(','),
    method: 'GET',
    success: function (response) {
      console.log('Filtered recipes:', response);
      // Update to show Card
      displayFilteredRecipes(response);
    },
    error: function (error) {
      console.log('Error filtering recipes:', error);
    }
  });
} 

// Filter by cuisine ONLY
else if(selectedCuisine.length > 0) {

    $.ajax({
      url: '/recipes/cuisine_filter/' + selectedCuisine.join(','),
      type: 'GET',
      success: function (response) {
        console.log('Filtered recipes by cuisine:', response);
        //Update to show cards
        displayFilteredRecipes(response);
      },
      error: function (xhr, status, error) {
        console.log('Error filtering recipes by cuisine:', error);
      }
    });
  } 
  
  // No filters selected
  else {
    console.log("No filters selected");
    displayFilteredRecipes([]); // Clear the displayed recipes
  }
  
}

function displayFilteredRecipes(recipes) {
  const recipeResult = document.getElementById('recipeResult');
  recipeResult.innerHTML = '';

  if (recipes.length > 0) {
    recipes.forEach(recipe => {
      const card = document.createElement('div');
            card.className = 'card';

            const cardImage = document.createElement('img');
            cardImage.src = recipe.image;
            cardImage.className = "card-img-top";

            const cardBody = document.createElement('div');
            cardBody.className = 'card-body';

            const cardTitle = document.createElement('h5');
            cardTitle.className = 'card-title';
            cardTitle.textContent = recipe.title;

            const cardText = document.createElement('p');
            cardText.className = 'card-text';
            cardText.textContent = recipe.description;

             //Creates Button 
            const cardMore = document.createElement('button');
            cardMore.className = 'btn btn-custom';
            cardMore.textContent = "Show More";

            //'Listens' if the button is clicked, if so, run openModal()
            cardMore.addEventListener('click', () => {
                openModal(recipe);
            });

            card.appendChild(cardImage);
            cardBody.appendChild(cardTitle);
            cardBody.appendChild(cardText);
            cardBody.appendChild(cardMore);
            card.appendChild(cardBody);
            recipeResult.appendChild(card);
    });
  }
}

function showAllRecipe(ingredients){

//Reset Cuisine 
selectedCuisine = null;
selectedIngredients = null;

//Clear any checkbox ticks
const checkboxes = document.querySelectorAll(".ingredient_list input[type=checkbox]");
checkboxes.forEach(checkbox => {
    checkbox.checked = false;
});;

const checkboxes2 = document.querySelectorAll(".cuisine-list input[type=checkbox]");
checkboxes2.forEach(checkbox2 => {
    checkbox2.checked = false;
});;

//Ajax Route
$.ajax({
      url: '/recipes',
      type: 'GET',
      success: function (response) {
        console.log('Filtered recipes successfully');
        //Update to show cards
        displayFilteredRecipes(response);
      },
      error: function (xhr, status, error) {
        console.log('Error filtering recipes by cuisine:', error);
      }
    });

//Declare Variables
const recipeResult = document.getElementById('recipeResult');
recipeResult.innerHTML = '';

recipes.forEach(recipe => {
    const card = document.createElement('div');
    card.className = 'card';

    const cardImage = document.createElement('img');
    cardImage.src = recipe.image;
    cardImage.className = "card-img-top";

    const cardBody = document.createElement('div');
    cardBody.className = 'card-body';

    const cardTitle = document.createElement('h5');
    cardTitle.className = 'card-title';
    cardTitle.textContent = recipe.title;

    const cardText = document.createElement('p');
    cardText.className = 'card-text';
    cardText.textContent = recipe.description;

    //Creates Button 
    const cardMore = document.createElement('button');
    cardMore.className = 'btn btn-custom';
    cardMore.textContent = "Show More";

    //'Listens' if the button is clicked, if so, run openModal()
    cardMore.addEventListener('click', () => {
        openModal(recipe);
    });

    card.appendChild(cardImage);
    cardBody.appendChild(cardTitle);
    cardBody.appendChild(cardText);
    cardBody.appendChild(cardMore);
    card.appendChild(cardBody);
    recipeResult.appendChild(card);

});

};

// Code for Modal
function openModal(recipe) {
    const modalTitle = document.querySelector('.modal-title');
    const modalBody = document.querySelector('.modal-body');

    // Clear previous modal content
    modalTitle.textContent = '';
    modalBody.innerHTML = '';

    const recipeImage = document.createElement('img');
    recipeImage.src = recipe.image;
    recipeImage.width="450";
    recipeImage.height="300";
    recipeImage.style.display = 'block';
    recipeImage.style.margin = '0 auto';

    const modalDescHeading = document.createElement('h5');
    modalDescHeading.textContent = 'Description';

    const modalDesc = document.createElement('p');
    modalDesc.textContent = recipe.description;
    
    const modalIngrHeading = document.createElement('h5');
    modalIngrHeading.textContent = 'Ingredients:';

    const recipeList = document.createElement('ul');
    recipe.ingredients.forEach(ingredient => {
        const listItem = document.createElement('li');
        listItem.textContent = ingredient;
        recipeList.appendChild(listItem);
    });

    const modalStepHeading = document.createElement('h5');
    modalStepHeading.textContent = 'Steps:';

    const modalSteps = document.createElement('p');
    modalSteps.type = "1";
    let stepNumber = 1;

    recipe.steps.forEach(ingredient => {
        const listItem2 = document.createElement('p');
        listItem2.textContent = stepNumber + '. ' + ingredient;
        modalSteps.appendChild(listItem2);
        stepNumber++;
    });


    // Set modal title and body content based on the recipe
    modalTitle.textContent = recipe.title;
    
    modalBody.appendChild(recipeImage);
    modalBody.appendChild(document.createElement('br'));
    modalBody.appendChild(modalDescHeading);
    modalBody.appendChild(modalDesc);
    modalBody.appendChild(document.createElement('br'));
    modalBody.appendChild(modalIngrHeading);
    modalBody.appendChild(recipeList);
    modalBody.appendChild(document.createElement('br'));
    modalBody.appendChild(modalStepHeading);
    modalBody.appendChild(modalSteps);

    // Show the modal
    const modal = document.getElementById('myModal');
    const modalInstance = new bootstrap.Modal(modal);
    modalInstance.show();

    // Get the "Close" button element
    const closeButton = document.querySelector('.modal-header button[data-dismiss="modal"]');

    // Add event listener to the close button
    closeButton.addEventListener('click', function() {
        modalInstance.hide();
    });
};

</script>
    
</html>